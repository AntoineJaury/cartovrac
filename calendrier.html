<!DOCTYPE html>
<html>
  <body>
    <meta charset="UTF-8">
    <script type="text/javascript">
		var requestURL = 'events.json';
    // requestURL = 'https://openagenda.com/agendas/17121232/events.json?oaq[from]=2018-08-29&oaq[to]=2018-10-09&oaq[what]=Loire-Atlantique&oaq[scope]=department';
		var request = new XMLHttpRequest();
		request.open('GET', requestURL, true);
		request.responseType = 'json';
		request.send();

    var getQueryParam = function(param) {
      var found;
      window.location.search.substr(1).split("&").forEach(function(item) {
        if (param == item.split("=")[0]) {
          found = item.split("=")[1];
        }
      });
      return found;
    };

		request.onload = function() {
      var today = new Date();
  		var jsonObj = request.response;
  	  var type_event = jsonObj['events'];

      document.write("<html><head>");
      document.write("<style> .wrap{ border:1px dotted brown;} .wrap>div{float:left;} .wrap>:first-child {width:20%;} .wrap>:nth-child(2n){width:40%;} .wrap>:nth-child(3n){width:20%;} .wrap>:nth-child(4n){width:20%;} .wrap>:last-child{width:20%;} @media (max-width: 40em) {  .wrap>div.truc { float:none;width:auto; }} .clear{clear:both;} </style>");
      // document.write("<style>@media (min-width: 40em) {  .wrap {    display: table;    table-layout: fixed;    width: 100%;  }  .wrap > * {    display: table-cell;    table-layout: fixed;  }  .wrap > :first-child {    width: 70%;  }}</style>");
      document.write("</head><body>");

      var weekday = new Array(7);
      weekday[0] =  "Dimanche";
      weekday[1] = "Lundi";
      weekday[2] = "Mardi";
      weekday[3] = "Mercredi";
      weekday[4] = "Jeudi";
      weekday[5] = "Vendredi";
      weekday[6] = "Samedi";

      for (var i = 0; i < type_event.length; i++) {
        var show = true;

        if (typeof getQueryParam("department") == "undefined") {
          if (type_event[i].department!="Loire-Atlantique") {
            show = false;
          }
        }
        if (show==true) {
          document.write("<div class='wrap'><div class='truc'>");

          if (type_event[i].thumbnail == false) {
            document.write("&nbsp;");
          }
          else {
            document.write("<img src='"+type_event[i].thumbnail+"' width='100px' style='max-width:100px;height:auto' />");
          }

          document.write("</div><div class='truc'>");
          document.write("<b>"+type_event[i].title.fr+"</b>");
          document.write("<br/>"+type_event[i].description.fr);
          /*if (typeof type_event[i].keywords !== "undefined") {
            document.write("<br/><br/><i>"+type_event[i].keywords.fr+"</i>");
          }*/
          document.write("</div><div class='truc'>");
          var nbEvent = 0;
          for(var j = 0; j < type_event[i].timings.length; j++) {
            var eventStartDate = new Date(type_event[i].timings[j].start);
            var timeDiff = eventStartDate.getTime() - today.getTime();
            var diffDays = Math.ceil(timeDiff / (1000 * 3600 * 24));
            if (diffDays<=60 && nbEvent<3) {
              document.write("- " + weekday[eventStartDate.getDay()]);
              document.write(" " + type_event[i].timings[j].start.substring(8,10) + " ");
              var mois = type_event[i].timings[j].start.substring(5,7).replace("01", "janvier")
               .replace("02", "février").replace("03", "mars").replace("04", "avril").replace("05", "mai").replace("06", "juin").replace("07", "juillet")
               .replace("08", "aôut").replace("09", "septembre").replace("10", "octobre").replace("11", "novembre").replace("12", "décembre");
              document.write(mois + " ");
              document.write(type_event[i].timings[j].start.substring(0,4));
              document.write(", "+type_event[i].timings[j].start.substring(11,16));
              document.write(" à "+type_event[i].timings[j].end.substring(11,16));
              document.write("<br/>");
            }
            if (nbEvent==3) {
              document.write("...");
            }
            nbEvent++;
          }
          document.write("</div><div class='truc'>");
          document.write("<address>");
          document.write(type_event[i].locationName);
          document.write(" : ");
          document.write(type_event[i].address);
          document.write("</address><br/>");
          document.write(type_event[i].conditions.fr);
          document.write("</div></div>");
          document.write("<div class='clear'></div>");
          document.write("<br/>");
        }
      }
      document.write("</body></html>");
    }
    </script>
  </body>
</html>
